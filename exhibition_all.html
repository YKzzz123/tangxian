<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全唐诗游仙诗数据分析 - 寻仙唐迹</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="./images/logo.png">
    <link rel="apple-touch-icon" href="./images/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入ECharts.js用于数据可视化 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- 引入Leaflet用于地图可视化 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@400;700&display=swap"
        rel="stylesheet">

    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow-gold {
                text-shadow: 0 0 5px rgba(212, 175, 55, 0.7);
            }
            .bg-paper-texture {
                background-color: #F5F1E6;
                background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%239C92AC' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
            }
            .visualization-card {
                transition: all 0.3s ease;
            }
            .visualization-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            .nav-active {
                border-left: 4px solid #D4AF37;
                background-color: rgba(212, 175, 55, 0.1);
            }
            /* 确保Leaflet地图控件的z-index低于导航栏 */
            .leaflet-container {
                z-index: 1 !important;
            }
            .leaflet-control-container {
                z-index: 10 !important;
            }
            .leaflet-top,
            .leaflet-bottom {
                z-index: 10 !important;
            }
            .leaflet-control {
                z-index: 10 !important;
            }
            .leaflet-control-zoom {
                z-index: 10 !important;
            }
            .leaflet-control-attribution {
                z-index: 10 !important;
            }
            .leaflet-pane {
                z-index: 1 !important;
            }
            /* 地图容器本身也要设置较低的z-index */
            #immortalLocationMap {
                position: relative;
                z-index: 1 !important;
            }
            /* 地图切换按钮的z-index - 确保在地图容器内，但低于导航栏 */
            .map-control-buttons {
                position: absolute !important;
                z-index: 20 !important;
            }
            /* 自定义标记图标样式 */
            .custom-marker-icon {
                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
                transition: transform 0.2s ease;
            }
            .custom-marker-icon:hover {
                transform: scale(1.1);
            }
            /* 确保Leaflet标记图标正确显示 */
            .leaflet-marker-icon {
                border: none !important;
                background: transparent !important;
            }
        }
        
        /* 暗色模式下的文字颜色适配 */
        body.theme-dark .text-gray-700,
        body.theme-dark .text-gray-600,
        body.theme-dark .text-gray-800 {
            color: var(--color-text-primary) !important;
        }
        
        body.theme-dark .text-ink {
            color: var(--color-text-primary) !important;
        }
        
        body.theme-dark .border-gray-200,
        body.theme-dark .border-gray-300 {
            border-color: rgba(148, 163, 184, 0.3) !important;
        }
        
        body.theme-dark .hover\:bg-gray-100:hover {
            background-color: rgba(148, 163, 184, 0.15) !important;
        }
        
        body.theme-dark .bg-gray-50 {
            background-color: rgba(30, 41, 59, 0.5) !important;
        }
        
        body.theme-dark .bg-amber-50 {
            background-color: rgba(30, 41, 59, 0.6) !important;
        }
        
        body.theme-dark .bg-white {
            background-color: var(--color-surface-card-strong) !important;
        }
        
        body.theme-dark code {
            background-color: rgba(15, 23, 42, 0.8) !important;
            color: var(--color-text-primary) !important;
        }
        
        /* 暗色模式下地图切换按钮文字颜色 */
        body.theme-dark .map-control-buttons {
            background-color: rgba(30, 41, 59, 0.95) !important;
        }
        
        body.theme-dark .map-control-buttons button {
            color: var(--color-text-primary) !important;
        }
        
        body.theme-dark .map-control-buttons button.bg-gray-400 {
            background-color: rgba(148, 163, 184, 0.3) !important;
        }
        
        /* 暗色模式下图例文字颜色 */
        body.theme-dark #mapLegend span {
            color: var(--color-text-primary) !important;
        }
    </style>

    <script src="components.js"></script>
    <script>document.write(styleComponent);</script>
</head>

<body class="bg-moon-white font-classic text-gray-800 overflow-x-hidden scroll-smooth">
    <!-- 时期分类导航 -->
    <div class="bg-ink text-white py-3 shadow-lg fixed top-[4.75rem] w-full z-[1000]">
        <div class="container mx-auto px-4">
            <div class="flex overflow-x-auto items-center justify-center py-1" style="gap: 0;">
                <a href="exhibition_all.html"
                    class="period-btn active whitespace-nowrap px-4 py-1 rounded-full bg-golden text-ink font-medium text-sm md:text-base transition-all">全唐</a>
                <a href="exhibition_chu.html"
                    class="period-btn whitespace-nowrap px-4 py-1 rounded-full hover:bg-white/20 text-sm md:text-base transition-all">初唐</a>
                <a href="exhibition_sheng.html"
                    class="period-btn whitespace-nowrap px-4 py-1 rounded-full hover:bg-white/20 text-sm md:text-base transition-all">盛唐</a>
                <a href="exhibition_zhong.html"
                    class="period-btn whitespace-nowrap px-4 py-1 rounded-full hover:bg-white/20 text-sm md:text-base transition-all">中唐</a>
                <a href="exhibition_wan.html"
                    class="period-btn whitespace-nowrap px-4 py-1 rounded-full hover:bg-white/20 text-sm md:text-base transition-all">晚唐</a>
            </div>
        </div>
    </div>

    <!-- 主要内容区 -->
    <div class="pt-28 min-h-screen flex flex-col md:flex-row">
        <!-- 左侧固定导航栏 -->
        <aside
            class="w-full md:w-64 bg-white/80 backdrop-blur-sm shadow-md md:h-[calc(100vh-7rem)] md:sticky md:top-28 overflow-y-auto">
            <div class="p-6">
                <h3 class="font-calligraphy text-xl text-celestial-blue mb-4 pb-2 border-b border-gray-200">可视化分析</h3>

                <!-- 全唐导航 -->
                <ul id="all-period-nav" class="space-y-1">
                    <li>
                        <a href="#overview"
                            class="visual-nav nav-active block px-4 py-3 text-ink hover:bg-gray-100 rounded-lg transition-colors">
                            <i class="fa fa-dashboard mr-2 text-golden"></i> 整体梗概
                        </a>
                    </li>
                    <li>
                        <a href="#period-comparison"
                            class="visual-nav block px-4 py-3 text-ink hover:bg-gray-100 rounded-lg transition-colors">
                            <i class="fa fa-exchange mr-2 text-celestial-blue"></i> 时期对比
                        </a>
                    </li>
                    <li>
                        <!-- 使用更可靠的自定义展开/折叠实现 -->
                        <div class="relative">
                            <button
                                class="visual-nav w-full text-left px-4 py-3 text-ink hover:bg-gray-100 rounded-lg transition-colors">
                                <i class="fa fa-picture-o mr-2 text-jade-green"></i> 意象研究
                                <i class="fa fa-chevron-down ml-2 transition-transform float-right"
                                    id="imagesDropdownIcon"></i>
                            </button>
                            <ul id="imagesSubmenu" class="pl-6 mt-1 space-y-1 hidden">
                                <li>
                                    <a href="#gender-analysis"
                                        class="visual-nav block px-4 py-2 text-ink hover:bg-gray-100 rounded-lg transition-colors text-sm">
                                        <i class="fa fa-venus-mars mr-2 text-rose-pink"></i> 性别研究
                                    </a>
                                </li>
                                <li>
                                    <a href="#type-analysis"
                                        class="visual-nav block px-4 py-2 text-ink hover:bg-gray-100 rounded-lg transition-colors text-sm">
                                        <i class="fa fa-sitemap mr-2 text-indigo-blue"></i> 类型研究
                                    </a>
                                </li>
                                <li>
                                    <a href="#cooccurrence-analysis"
                                        class="visual-nav block px-4 py-2 text-ink hover:bg-gray-100 rounded-lg transition-colors text-sm">
                                        <i class="fa fa-share-alt mr-2 text-purple-600"></i> 仙人意象共现分析
                                    </a>
                                </li>
                                <li>
                                    <a href="#location-gis-analysis"
                                        class="visual-nav block px-4 py-2 text-ink hover:bg-gray-100 rounded-lg transition-colors text-sm">
                                        <i class="fa fa-map-marker mr-2 text-green-600"></i> 仙人所在地GIS分析
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </div>
        </aside>

        <!-- 右侧内容区 -->
        <main class="flex-1 p-4 md:p-6">
            <div class="max-w-6xl mx-auto w-full">
                <!-- 页面标题 -->
                <div class="mb-10 text-center">
                    <h1
                        class="font-calligraphy text-[clamp(1.8rem,4vw,3rem)] text-celestial-blue mb-4 text-shadow-gold">
                        全唐诗游仙诗数据分析
                    </h1>
                    <p class="text-gray-600 max-w-3xl mx-auto">
                        探索唐代游仙诗的创作趋势、主题分布与艺术特色，揭示不同时期游仙诗的发展脉络
                    </p>
                    <div class="w-32 h-1 bg-golden mx-auto mt-6"></div>
                </div>

                <!-- 全唐内容 -->
                <section id="all-tang-section" class="period-section">
                    <section id="overview" class="mb-16 scroll-mt-28">
                        <div class="bg-white rounded-xl shadow-md p-6 mb-8 visualization-card">
                            <h2 class="font-calligraphy text-2xl text-celestial-blue mb-6 flex items-center">
                                <i class="fa fa-dashboard mr-2 text-golden"></i> 游仙诗整体概览
                            </h2>
                            <div class="prose max-w-none mb-8">
                                <p class="text-gray-700 leading-relaxed mb-6">
                                    游仙诗是诗人借厌世隐遁、寻仙访道、游历仙境等题材内容，抒写作者的愤世嫉俗之情，或企求长生不老的意愿的一种诗歌类型。它以仙人、仙境、仙术等虚幻性意象为核心意象，而在这些意象当中，仙人意象又是核心之核心。
                                </p>
                                <p class="text-gray-700 leading-relaxed mb-6">
                                    下面，让我们一起通过探索唐代游仙诗中的仙人意象及其流变轨迹，体会当时的时代风气和人文思想。
                                </p>
                            </div>

                            <!-- 各时期游仙诗占比饼图和各时期游仙诗数量 -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                                <div class="h-80">
                                    <h3 class="text-lg font-medium text-gray-700 mb-4 text-center">各时期游仙诗占比</h3>
                                    <div id="percentageChart" class="w-full h-full"></div>
                                </div>
                                <div class="h-80">
                                    <h3 class="text-lg font-medium text-gray-700 mb-4 text-center">各时期游仙诗数量</h3>
                                    <div id="periodComparisonChart" class="w-full h-full"></div>
                                </div>
                            </div>

                            <!-- 文字分析 -->
                            <div class="mb-8">
                                <div class="prose max-w-none">
                                    <p class="text-gray-700 leading-relaxed">
                                        《全唐诗》是清代康熙四十四年（1705年）在康熙帝的主导下编纂而成的唐诗合集。"得诗四万八千九百余首，凡二千二百余人，厘为九百卷"。基于颜进雄所著的《唐代游仙诗研究》，《全唐诗》中共有游仙诗282首，占比0.94%。其中初唐52首，盛唐79首，中唐67首，晚唐84首。
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- 诗人作品数量分析（作为整体梗概的一部分） -->
                        <div id="poet-analysis" class="bg-white rounded-xl shadow-md p-6 mt-8 visualization-card">
                            <h3 class="font-calligraphy text-xl text-celestial-blue mb-6 flex items-center">
                                <i class="fa fa-trophy mr-2 text-golden"></i> 诗人作品数量分析
                            </h3>
                            <div class="prose max-w-none mb-8">
                                <p class="text-gray-700 leading-relaxed mb-6">
                                    基于对《全唐诗》中282首游仙诗的统计分析，共有83位诗人参与了游仙诗的创作。这些诗人的创作数量分布极不均衡，其中李白以57首游仙诗遥遥领先，占总数的20.2%。这种分布体现了游仙诗创作中的个体差异和“大家”的影响力。
                                </p>
                                <p class="text-gray-700 leading-relaxed">
                                    下面的图表展示了游仙诗创作数量最多的前20位诗人，从数据可以看出，仅有少数诗人（如李白、曹唐、宋之问等）创作了大量游仙诗，而大多数诗人仅创作了1-2首。这种“长尾分布”现象在文学创作中较为常见，反映了唐代诗人对游仙主题的不同偏好和关注程度。
                                </p>
                            </div>
                            <h3 class="text-lg font-medium text-gray-700 mb-4">唐代诗人游仙诗作品数量排名（前20名）</h3>
                            <div id="poetRankingChart" class="w-full h-96"></div>
                            <div class="prose max-w-none mb-8">
                                <p class="text-gray-700 leading-relaxed mb-6">
                                    图片展示了唐代游仙诗的作品数目排名。李白、曹唐、宋之问、陆龟蒙、李商隐是撰写游仙诗数量最多的唐代文人，其中李白所作游仙诗的数目更是高达57首。
                                </p>
                            </div>
                        </div>
                    </section>

                    <!-- 2. 时期对比 -->
                    <section id="period-comparison" class="mb-16 scroll-mt-28">
                        <div class="bg-white rounded-xl shadow-md p-6 visualization-card">
                            <h2 class="font-calligraphy text-2xl text-celestial-blue mb-6 flex items-center">
                                <i class="fa fa-exchange mr-2 text-celestial-blue"></i> 时期对比
                            </h2>
                            <div class="prose max-w-none mb-8">
                                <p class="text-gray-700 leading-relaxed">
                                    在282首唐代游仙诗中，仙人意象一共出现了340次，包括135名仙人。仙人意象的出现次数和数量在各个时期也有所变化。
                                </p>
                            </div>

                            <!-- 各时期仙人意象出现次数 -->
                            <div class="mb-8">
                                <h3 class="text-lg font-medium text-gray-700 mb-4">各时期仙人意象出现次数</h3>
                                <div id="immortalFrequencyChart" class="w-full h-80"></div>
                            </div>

                            <!-- 唐代诗歌中最常出现的仙人（前20名） -->
                            <div class="mb-8">
                                <h3 class="text-lg font-medium text-gray-700 mb-4 text-center">唐代诗歌中最常出现的仙人（前20名）</h3>
                                <div id="topImmortalsChart" class="w-full h-96"></div>
                            </div>

                            <!-- 仙人时代分布热力图 -->
                            <div class="mb-8">
                                <h3 class="text-lg font-medium text-gray-700 mb-4">主要仙人意象的时代分布热力图</h3>
                                <div id="immortalHeatmapChart" class="w-full h-80"></div>
                            </div>

                            <!-- 主要仙人的时代分布（前5名）和流行度趋势图合并 -->
                            <div class="mb-8">
                                <h3 class="text-lg font-medium text-gray-700 mb-4">主要仙人的时代分布与流行度趋势（前5名）</h3>
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <div>
                                        <h4 class="text-md font-medium text-gray-600 mb-4 text-center">时代分布</h4>
                                        <div id="topImmortalsByPeriodChart" class="w-full h-80"></div>
                                    </div>
                                    <div>
                                        <h4 class="text-md font-medium text-gray-600 mb-4 text-center">流行度趋势</h4>
                                        <div id="immortalTrendChart" class="w-full h-80"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="prose max-w-none mb-8">
                                <p class="text-gray-700 leading-relaxed">
                                    图表展示了唐代游仙诗中仙人意象的出现次数排名。西王母、王子乔、麻姑、玉皇大帝、弄玉是唐代游仙诗中最频繁出现的仙人意象，他们在不同时期中的出现次数也有所起伏。
                                    通过这一排名我们同样可以看到，在最常出现仙人意象中，女性仙人的数量也绝不在男性仙人的数量之下。
                                </p>
                            </div>
                        </div>
                    </section>

                    <!-- 3. 意象研究 - 性别研究 -->
                    <section id="gender-analysis" class="mb-16 scroll-mt-28">
                        <div class="bg-white rounded-xl shadow-md p-6 visualization-card">
                            <h2 class="font-calligraphy text-2xl text-celestial-blue mb-6 flex items-center">
                                <i class="fa fa-venus-mars mr-2 text-rose-pink"></i> 仙人意象性别研究
                            </h2>
                            <div class="prose max-w-none mb-8">
                                <p class="text-gray-700 leading-relaxed mb-6">
                                    在这135名仙人中，男性仙人有95名，女性仙人有40名。
                                </p>
                                <p class="text-gray-700 leading-relaxed">
                                    不难发现一个有趣的现象：女性仙人意象的占比在逐渐增多，甚至在中唐时期超过了男性仙人的数量。
                                </p>
                            </div>

                            <!-- 仙人性别分布饼图 -->
                            <div class="mb-8">
                                <h3 class="text-lg font-medium text-gray-700 mb-4 text-center">仙人性别分布</h3>
                                <div id="genderDistributionPieChart" class="w-full h-80 mx-auto max-w-md"></div>
                            </div>

                            <!-- 性别分布图表 -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                                <div>
                                    <h3 class="text-lg font-medium text-gray-700 mb-4">各时期仙人意象性别分布</h3>
                                    <div id="genderDistributionChart" class="w-full h-80"></div>
                                </div>
                                <div>
                                    <h3 class="text-lg font-medium text-gray-700 mb-4 flex items-center">
                                        女性仙人意象占比变化趋势
                                        <span class="relative ml-2 group cursor-help">
                                            <i
                                                class="fa fa-question-circle text-celestial-blue/60 hover:text-celestial-blue transition-colors"></i>
                                            <span
                                                class="absolute left-1/2 bottom-full mb-2 transform -translate-x-1/2 w-64 p-3 bg-gray-800 text-white text-sm rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 pointer-events-none">
                                                为什么女性仙人意象的占比在逐渐增多呢？
                                                <span
                                                    class="absolute left-1/2 top-full transform -translate-x-1/2 -mt-1 border-4 border-transparent border-t-gray-800"></span>
                                            </span>
                                        </span>
                                    </h3>
                                    <div id="femaleRatioChart" class="w-full h-80"></div>
                                </div>
                            </div>
                            <div class="prose max-w-none mb-8">
                                <p class="text-gray-700 leading-relaxed mb-6">
                                    中唐安史之乱后，世风日下，人们注重现实享乐，致使社会上、恋女冠之风盛行。在中唐文人看来，天上的仙女具有非凡之美，最能满足他们纵欲享乐的嗜好，而且她们熟知道术，得到了她们也就等于找到了成仙的秘诀。
                                </p>
                                <p class="text-gray-700 leading-relaxed">
                                    因此，艳情的仙化在这一时期成为游仙诗的一种普遍现象。男女道士之恋、士人与女冠之恋、士人与妓女之恋、俗世中的男女之恋，甚至帝妃之恋都被置于仙境来表现。
                                </p>
                            </div>
                        </div>
                    </section>

                    <!-- 4. 意象研究 - 类型研究 -->
                    <section id="type-analysis" class="mb-16 scroll-mt-28">
                        <div class="bg-white rounded-xl shadow-md p-6 visualization-card">
                            <h2 class="font-calligraphy text-2xl text-celestial-blue mb-6 flex items-center">
                                <i class="fa fa-sitemap mr-2 text-indigo-blue"></i> 仙人意象类型研究
                            </h2>
                            <div class="prose max-w-none mb-8">
                                <p class="text-gray-700 leading-relaxed mb-6">
                                    从意象的内涵出发，唐代游仙诗的仙人意象可被分为三大类：类型化仙人、凡人成仙者、个性鲜明的天界众仙。
                                </p>
                                <p class="text-gray-700 leading-relaxed mb-6">
                                    <strong> · 类型化仙人，</strong>指在游仙诗中缺乏个性、只是作为仙人群体代表而出现的仙人意象，如“玉女”“羽人”等；<br>
                                    <strong>·
                                        凡人成仙者，</strong>顾名思义，指那些本是凡人，后来靠巧遇仙人或者自行修道、服食仙药升天成仙的人。这类仙人意象的典型是王子乔、黄帝和黄初平；<br>
                                    <strong>· 个性鲜明的天界众仙，</strong>指那些被游仙诗人特别关照、精心刻画, 因而具有鲜明个体特色的仙人，如西王母、玉皇大帝、杜兰香等。
                                </p>
                                <p class="text-gray-700 leading-relaxed mb-6">
                                    在这135名仙人中，近一半都为凡人成仙者。唐代诗人将此类意象纳入游仙诗中，以表达自己升仙超越的理想，和自己对道教的虔诚信仰。
                                </p>
                            </div>

                            <!-- 仙人类型分布图表 -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div>
                                    <h3 class="text-lg font-medium text-gray-700 mb-4">仙人类型分布饼图</h3>
                                    <div id="immortalTypePieChart" class="w-full h-80"></div>
                                </div>
                                <div>
                                    <h3 class="text-lg font-medium text-gray-700 mb-4">仙人类型数量柱状图</h3>
                                    <div id="immortalTypeBarChart" class="w-full h-80"></div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 5. 意象研究 - 仙人意象共现分析 -->
                    <section id="cooccurrence-analysis" class="mb-16 scroll-mt-28">
                        <div class="bg-white rounded-xl shadow-md p-6 visualization-card">
                            <h2 class="font-calligraphy text-2xl text-celestial-blue mb-6 flex items-center">
                                <i class="fa fa-share-alt mr-2 text-purple-600"></i> 仙人意象共现分析
                            </h2>
                            <div class="prose max-w-none mb-8">
                                <p class="text-gray-700 leading-relaxed mb-6">
                                    基于唐代诗歌中仙人共现数据的社会网络分析，我们可以通过可视化网络图来探索不同仙人之间的关系。网络图中的节点代表仙人，节点的大小表示出现频率，连线表示仙人之间的共现关系，连线的粗细和颜色代表关系的强度。
                                </p>
                            </div>

                            <div class="flex flex-col lg:flex-row gap-6 mb-8">
                                <!-- 网络图容器 -->
                                <div class="flex-1 bg-white rounded-lg p-4 shadow-inner" style="min-height: 800px;">
                                    <div class="mb-4 flex flex-wrap gap-2">
                                        <button class="px-4 py-2 bg-purple-700 text-white rounded-lg hover:bg-purple-800 transition-colors ring-2 ring-purple-300" onclick="toggleLayout('force')" id="btn-force">力导向图 (聚类)</button>
                                        <button class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors" onclick="toggleLayout('circular')" id="btn-circular">环形布局</button>
                                        <button class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors" onclick="highlightCoreImmortals()">高亮核心仙人</button>
                                        <button class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors" onclick="resetHighlight()">重置显示</button>
                                    </div>
                                    <div id="networkChart" style="width: 100%; height: 90%; min-height: 700px;"></div>
                                </div>

                                <!-- 侧边栏 -->
                                <div class="w-full lg:w-80 bg-gray-50 rounded-lg p-6 overflow-y-auto" style="max-height: 800px;">
                                    <div class="mb-6">
                                        <h3 class="text-lg font-medium text-gray-700 mb-4 border-b border-gray-300 pb-2">网络统计</h3>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div class="bg-white p-4 rounded-lg text-center shadow-sm">
                                                <div class="text-2xl font-bold text-purple-600">135</div>
                                                <div class="text-sm text-gray-600 mt-1">仙人总数</div>
                                            </div>
                                            <div class="bg-white p-4 rounded-lg text-center shadow-sm">
                                                <div class="text-2xl font-bold text-purple-600">654</div>
                                                <div class="text-sm text-gray-600 mt-1">共现关系</div>
                                            </div>
                                            <div class="bg-white p-4 rounded-lg text-center shadow-sm">
                                                <div class="text-2xl font-bold text-purple-600">14</div>
                                                <div class="text-sm text-gray-600 mt-1">核心仙人</div>
                                            </div>
                                            <div class="bg-white p-4 rounded-lg text-center shadow-sm">
                                                <div class="text-2xl font-bold text-purple-600">0.071</div>
                                                <div class="text-sm text-gray-600 mt-1">网络密度</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-6">
                                        <h3 class="text-lg font-medium text-gray-700 mb-4 border-b border-gray-300 pb-2">核心仙人（按分类排序）</h3>
                                        <div class="mb-4">
                                            <h4 class="text-sm font-semibold text-yellow-700 mb-2" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">個性鮮明的天界眾仙</h4>
                                            <ul class="space-y-2">
                                                <li class="bg-white p-3 rounded border-l-4 border-yellow-600 flex justify-between items-center shadow-sm" style="border-left-color: #DAA520; background: linear-gradient(90deg, rgba(218,165,32,0.1), transparent);">
                                                    <span class="font-medium text-gray-800">西王母</span>
                                                    <span class="text-red-600 font-bold">129</span>
                                                </li>
                                                <li class="bg-white p-3 rounded border-l-4 border-yellow-600 flex justify-between items-center shadow-sm">
                                                    <span class="font-medium text-gray-800">玉皇大帝</span>
                                                    <span class="text-red-600 font-bold">53</span>
                                                </li>
                                                <li class="bg-white p-3 rounded border-l-4 border-yellow-600 flex justify-between items-center shadow-sm">
                                                    <span class="font-medium text-gray-800">上元夫人</span>
                                                    <span class="text-red-600 font-bold">43</span>
                                                </li>
                                            </ul>
                                        </div>

                                        <div class="mb-4">
                                            <h4 class="text-sm font-semibold text-blue-700 mb-2" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">凡人成仙者</h4>
                                            <ul class="space-y-2">
                                                <li class="bg-white p-3 rounded border-l-4 border-blue-600 flex justify-between items-center shadow-sm" style="border-left-color: #4682B4; background: linear-gradient(90deg, rgba(70,130,180,0.1), transparent);">
                                                    <span class="font-medium text-gray-800">麻姑</span>
                                                    <span class="text-red-600 font-bold">42</span>
                                                </li>
                                                <li class="bg-white p-3 rounded border-l-4 border-blue-600 flex justify-between items-center shadow-sm">
                                                    <span class="font-medium text-gray-800">安期生</span>
                                                    <span class="text-red-600 font-bold">39</span>
                                                </li>
                                                <li class="bg-white p-3 rounded border-l-4 border-blue-600 flex justify-between items-center shadow-sm">
                                                    <span class="font-medium text-gray-800">劉晨</span>
                                                    <span class="text-red-600 font-bold">38</span>
                                                </li>
                                            </ul>
                                        </div>

                                        <div>
                                            <h4 class="text-sm font-semibold text-purple-700 mb-2" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">類型化仙人</h4>
                                            <ul class="space-y-2">
                                                <li class="bg-white p-3 rounded border-l-4 border-purple-600 flex justify-between items-center shadow-sm" style="border-left-color: #7B68EE; background: linear-gradient(90deg, rgba(123,104,238,0.1), transparent);">
                                                    <span class="font-medium text-gray-800">許飛瓊</span>
                                                    <span class="text-red-600 font-bold">40</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>

                                    <div>
                                        <h3 class="text-lg font-medium text-gray-700 mb-4 border-b border-gray-300 pb-2">关键共现关系</h3>
                                        <ul class="space-y-2">
                                            <li class="bg-white p-3 rounded border-l-4 border-green-600 shadow-sm">
                                                <div class="font-medium text-gray-800">東方朔 - 西王母</div>
                                                <div class="text-purple-600 font-bold text-sm mt-1">共现强度: 5</div>
                                            </li>
                                            <li class="bg-white p-3 rounded border-l-4 border-green-600 shadow-sm">
                                                <div class="font-medium text-gray-800">三官大帝 - 西王母</div>
                                                <div class="text-purple-600 font-bold text-sm mt-1">共现强度: 5</div>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 6. 意象研究 - 仙人所在地GIS分析 -->
                    <section id="location-gis-analysis" class="mb-16 scroll-mt-28">
                        <div class="bg-white rounded-xl shadow-md p-6 visualization-card">
                            <h2 class="font-calligraphy text-2xl text-celestial-blue mb-6 flex items-center">
                                <i class="fa fa-map-marker mr-2 text-green-600"></i> 仙人所在地GIS分析
                            </h2>
                            <div class="prose max-w-none mb-8">
                                <p class="text-gray-700 leading-relaxed mb-6">
                                    通过地理信息系统(GIS)分析，我们可以将唐代游仙诗中出现的仙人按照其所在地进行空间可视化。这些仙人所在地涵盖了核心仙山、天界仙境、山川秘境、水域秘境和道教圣地等多个类别，展现了唐代游仙诗中丰富的空间想象。
                                </p>
                                <p class="text-gray-700 leading-relaxed mb-4">
                                    地图上的标记点按照不同类别使用不同颜色和图标进行区分，点击标记点可以查看该地点的详细信息，包括所在地名称、类别、相关仙人以及相关介绍。
                                </p>
                            </div>

                            <!-- 地图容器 -->
                            <div class="mb-6 relative" style="z-index: 1; isolation: isolate;">
                                <!-- 地图切换按钮 -->
                                <div class="map-control-buttons absolute top-4 right-4 bg-white rounded-lg shadow-lg p-2 flex gap-2">
                                    <button id="modernMapBtn" class="px-4 py-2 bg-celestial-blue text-white rounded-md hover:bg-blue-700 transition-colors text-sm font-medium">
                                        <i class="fa fa-map mr-2"></i>现代地图
                                    </button>
                                    <button id="ancientMapBtn" class="px-4 py-2 bg-ochre text-white rounded-md hover:bg-orange-700 transition-colors text-sm font-medium">
                                        <i class="fa fa-scroll mr-2"></i>古代地图
                                    </button>
                                </div>
                                <div id="immortalLocationMap" style="width: 100%; height: 700px; border-radius: 8px; overflow: hidden; position: relative; z-index: 1;"></div>
                            </div>

                            <!-- 图例 -->
                            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                                <h3 class="text-lg font-medium text-gray-700 mb-4">图例</h3>
                                <div class="grid grid-cols-2 md:grid-cols-5 gap-4" id="mapLegend">
                                    <div class="flex items-center">
                                        <img src="./images/map/core_mount.png" alt="核心仙山" class="w-10 h-10 mr-3 object-contain" style="filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));">
                                        <span class="text-sm text-gray-700">核心仙山</span>
                                    </div>
                                    <div class="flex items-center">
                                        <img src="./images/map/sky.png" alt="天界仙境" class="w-10 h-10 mr-3 object-contain" style="filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));">
                                        <span class="text-sm text-gray-700">天界仙境</span>
                                    </div>
                                    <div class="flex items-center">
                                        <img src="./images/map/green_mount.png" alt="山川秘境" class="w-10 h-10 mr-3 object-contain" style="filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));">
                                        <span class="text-sm text-gray-700">山川秘境</span>
                                    </div>
                                    <div class="flex items-center">
                                        <img src="./images/map/sea.png" alt="水域秘境" class="w-10 h-10 mr-3 object-contain" style="filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));">
                                        <span class="text-sm text-gray-700">水域秘境</span>
                                    </div>
                                    <div class="flex items-center">
                                        <img src="./images/map/dao_mount.png" alt="道教圣地" class="w-10 h-10 mr-3 object-contain" style="filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));">
                                        <span class="text-sm text-gray-700">道教圣地</span>
                                    </div>
                                </div>
                            </div>

                            <div class="prose max-w-none">
                                <p class="text-gray-700 leading-relaxed">
                                    从地图分布可以看出，仙人所在地主要集中在中国的东部和中部地区，其中核心仙山如昆仑山、蓬莱山、终南山等是仙人意象出现频率最高的地点。天界仙境虽然在地理位置上较为集中，但在文学想象中占据重要地位。这些地理分布反映了唐代诗人对传统仙山和道教圣地的认知与想象。
                                </p>
                            </div>
                        </div>
                    </section>
            </div>
            </section>
        </main>
    </div>

    <script>
        // 左侧可视化导航切换
        document.querySelectorAll('.visual-nav').forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();

                // 移除所有活跃状态
                document.querySelectorAll('.visual-nav').forEach(item => {
                    item.classList.remove('nav-active');
                });
                // 添加当前活跃状态
                this.classList.add('nav-active');

                // 滚动到对应部分
                const targetId = this.getAttribute('href');
                document.querySelector(targetId).scrollIntoView({
                    behavior: 'smooth'
                });
            });
        });

        // 意象研究下拉菜单功能
        const imagesDropdownBtn = document.querySelector('.visual-nav.w-full');
        const imagesSubmenu = document.getElementById('imagesSubmenu');
        const imagesDropdownIcon = document.getElementById('imagesDropdownIcon');

        if (imagesDropdownBtn && imagesSubmenu && imagesDropdownIcon) {
            imagesDropdownBtn.addEventListener('click', function (e) {
                // 切换子菜单显示/隐藏
                imagesSubmenu.classList.toggle('hidden');
                // 切换图标旋转
                imagesDropdownIcon.classList.toggle('rotate-180');
                // 阻止事件冒泡
                e.stopPropagation();
            });

            // 点击页面其他地方关闭下拉菜单
            document.addEventListener('click', function () {
                if (!imagesSubmenu.classList.contains('hidden')) {
                    imagesSubmenu.classList.add('hidden');
                    imagesDropdownIcon.classList.remove('rotate-180');
                }
            });

            // 点击子菜单项时不关闭菜单
            if (imagesSubmenu.querySelectorAll('a')) {
                imagesSubmenu.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', function (e) {
                        // 保持菜单打开状态，让用户可以继续选择其他子项
                        e.stopPropagation();
                    });
                });
            }
        }

        // 滚动监听，实现右侧滚动时左侧导航自动高亮
        window.addEventListener('scroll', function () {
            // 获取所有内容区块和导航项
            const sections = document.querySelectorAll('section[id]');
            const navLinks = document.querySelectorAll('.visual-nav');

            let currentSection = '';

            // 检测当前在视口中的内容区块
            sections.forEach(section => {
                const sectionTop = section.offsetTop - 100; // 添加一些偏移量
                const sectionHeight = section.offsetHeight;
                const scrollY = window.scrollY;

                // 当滚动位置超过区块顶部且未超过区块底部时
                if (scrollY >= sectionTop && scrollY < sectionTop + sectionHeight) {
                    currentSection = '#' + section.getAttribute('id');
                }
            });

            // 更新导航栏高亮状态
            navLinks.forEach(link => {
                link.classList.remove('nav-active');
                if (link.getAttribute('href') === currentSection) {
                    link.classList.add('nav-active');
                }
            });
        });

        // 初始化页面时触发一次滚动事件，确保正确高亮当前区块
        window.dispatchEvent(new Event('scroll'));

        // 存储所有图表实例
        const charts = {};
        // 存储从JSON加载的数据
        const immortalData = {
            all: [],
            chu: [],
            sheng: [],
            zhong: [],
            wan: [],
            female: [],
            male: []
        };

        // 存储诗人数据
        const poetData = {
            ranking: []
        };

        // 加载JSON数据
        async function loadAllData() {
            try {
                // 使用all_immortals.csv作为主要数据源
                const allImmortalsResponse = await fetch('./database/仙人意象汇总/all_immortals.csv');
                const allImmortalsText = await allImmortalsResponse.text();
                const allImmortalsRows = allImmortalsText.split('\n').slice(1).filter(row => row.trim());

                // 解析all_immortals.csv数据
                const immortalsData = allImmortalsRows.map(row => {
                    const [name, chu, sheng, zhong, wan, total, gender, type] = row.split(',');
                    return {
                        name,
                        chu: parseInt(chu) || 0,
                        sheng: parseInt(sheng) || 0,
                        zhong: parseInt(zhong) || 0,
                        wan: parseInt(wan) || 0,
                        total: parseInt(total) || 0,
                        gender: gender || '',
                        type: type || ''
                    };
                });

                // 填充immortalData.all（用于整体统计）
                immortalData.all = immortalsData.map(item => ({
                    immortal: item.name,
                    occurance: item.total,
                    gender: item.gender,
                    type: item.type
                }));

                // 填充各时期数据
                const periods = ['chu', 'sheng', 'zhong', 'wan'];
                periods.forEach(period => {
                    immortalData[period] = immortalsData
                        .filter(item => item[period] > 0)
                        .map(item => ({
                            immortal: item.name,
                            occurance: item[period],
                            gender: item.gender
                        }));
                });

                // 填充性别数据
                immortalData.female = immortalsData
                    .filter(item => item.gender === '女' && item.total > 0)
                    .map(item => ({
                        immortal: item.name,
                        occurance: item.total
                    }));

                immortalData.male = immortalsData
                    .filter(item => item.gender === '男' && item.total > 0)
                    .map(item => ({
                        immortal: item.name,
                        occurance: item.total
                    }));

                // 从四个时期的updated.json文件中加载游仙诗数据
                const [chuJson, shengJson, zhongJson, wanJson] = await Promise.all([
                    fetch('./database/全唐诗中的游仙诗/chu_updated.json').then(res => res.json()),
                    fetch('./database/全唐诗中的游仙诗/sheng_updated.json').then(res => res.json()),
                    fetch('./database/全唐诗中的游仙诗/zhong_updated.json').then(res => res.json()),
                    fetch('./database/全唐诗中的游仙诗/wan_updated.json').then(res => res.json())
                ]);

                // 统计各时期游仙诗数量
                window.immortalityPoemsByPeriod = {
                    chu: chuJson.length,
                    sheng: shengJson.length,
                    zhong: zhongJson.length,
                    wan: wanJson.length
                };

                // 计算游仙诗总数
                window.immortalityPoemsCount = window.immortalityPoemsByPeriod.chu +
                    window.immortalityPoemsByPeriod.sheng +
                    window.immortalityPoemsByPeriod.zhong +
                    window.immortalityPoemsByPeriod.wan;
                console.log('游仙诗总数:', window.immortalityPoemsCount);
                console.log('各时期游仙诗数量:', window.immortalityPoemsByPeriod);

                // 统计诗人数据（从四个时期的文件中合并统计）
                const poetStats = {};
                const allPeriodData = [...chuJson, ...shengJson, ...zhongJson, ...wanJson];
                allPeriodData.forEach(poem => {
                    if (poem.author) {
                        poetStats[poem.author] = (poetStats[poem.author] || 0) + 1;
                    }
                });

                // 转换为排序后的诗人排名
                poetData.ranking = Object.entries(poetStats)
                    .map(([name, count]) => ({ name, count }))
                    .sort((a, b) => b.count - a.count);

                console.log('诗人数据加载完成:', poetData);

                console.log('数据加载完成:', immortalData);
                return true;
            } catch (error) {
                console.error('数据加载失败:', error);
                // 加载失败时使用模拟数据
                console.log('使用模拟数据...');

                // 模拟数据 - 确保图表能正常显示
                immortalData.all = [
                    { immortal: '西王母', occurance: 43, gender: '女' },
                    { immortal: '王子乔', occurance: 18, gender: '男' },
                    { immortal: '弄玉', occurance: 11, gender: '女' },
                    { immortal: '麻姑', occurance: 13, gender: '女' },
                    { immortal: '玉皇大帝', occurance: 10, gender: '男' }
                ];

                immortalData.female = [
                    { immortal: '西王母', occurance: 43 },
                    { immortal: '弄玉', occurance: 11 },
                    { immortal: '麻姑', occurance: 13 }
                ];

                immortalData.male = [
                    { immortal: '王子乔', occurance: 18 },
                    { immortal: '玉皇大帝', occurance: 10 }
                ];

                const periodData = [
                    { immortal: '西王母', occurance: 3 },
                    { immortal: '王子乔', occurance: 3 },
                    { immortal: '弄玉', occurance: 2 }
                ];

                periods.forEach(period => {
                    immortalData[period] = periodData;
                });

                // 模拟诗人数据
                poetData.ranking = [
                    { name: '李白', count: 57 },
                    { name: '曹唐', count: 21 },
                    { name: '宋之問', count: 15 },
                    { name: '陸龜蒙', count: 12 },
                    { name: '李商隱', count: 11 },
                    { name: '施肩吾', count: 9 },
                    { name: '吳筠', count: 8 },
                    { name: '陳陶', count: 7 },
                    { name: '韋應物', count: 6 },
                    { name: '李賀', count: 6 }
                ];

                return true;
            }
        }

        // 获取当前主题的文字颜色（用于图表）
        function getThemeTextColor() {
            if (document.body.classList.contains('theme-dark')) {
                return '#e2e8f0'; // 暗色模式下的浅色文字
            } else if (document.body.classList.contains('theme-eye')) {
                return '#3d4b2f'; // 护眼模式下的深绿色文字
            } else {
                return '#2D2D2D'; // 默认模式下的深色文字
            }
        }

        // 初始化所有图表
        async function initAllCharts() {
            // 先加载数据
            const dataLoaded = await loadAllData();
            if (!dataLoaded) {
                console.error('数据加载失败，无法初始化图表');
                return;
            }
            
            // 获取当前主题的文字颜色
            const themeTextColor = getThemeTextColor();
            // 1. 前20名仙人柱状图
            if (document.getElementById('topImmortalsChart')) {
                // 使用加载的数据获取前20名仙人
                const top20Immortals = [...immortalData.all]
                    .sort((a, b) => b.occurance - a.occurance)
                    .slice(0, 20)
                    .reverse(); // 反转以便在图表中从上到下显示最高到最低

                // 准备数据格式
                const chartData = top20Immortals.map(item => ({
                    value: item.occurance,
                    itemStyle: {
                        color: item.gender === '女' ? '#ec4899' : '#3b82f6'
                    }
                }));

                charts.topImmortalsChart = echarts.init(document.getElementById('topImmortalsChart'));
                const topImmortalsOption = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        },
                        formatter: function (params) {
                            const name = params[0].name;
                            const value = params[0].value;
                            const gender = params[0].color === '#ec4899' ? '女' : '男';
                            return name + '<br/>性别: ' + gender + '<br/>出现次数: ' + value;
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '15%',
                        top: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'value',
                        name: '出现次数',
                        nameLocation: 'middle',
                        nameGap: 30
                    },
                    yAxis: {
                        type: 'category',
                        data: top20Immortals.map(item => item.immortal),
                        axisLabel: {
                            fontSize: 11
                        }
                    },
                    series: [
                        {
                            type: 'bar',
                            emphasis: {
                                focus: 'series'
                            },
                            data: chartData
                        }
                    ]
                };
                charts.topImmortalsChart.setOption(topImmortalsOption);
                window.addEventListener('resize', () => charts.topImmortalsChart.resize());
            }

            // 2. 仙人性别分布饼图
            if (document.getElementById('genderDistributionPieChart')) {
                // 使用加载的数据计算性别分布
                const genderStats = {
                    女: immortalData.all.filter(item => item.gender === '女').length,
                    男: immortalData.all.filter(item => item.gender === '男').length
                };

                charts.genderDistributionPieChart = echarts.init(document.getElementById('genderDistributionPieChart'));
                const genderPieOption = {
                    tooltip: {
                        trigger: 'item',
                        formatter: '{b}: {c}人 ({d}%)'
                    },
                    legend: {
                        bottom: 10,
                        left: 'center'
                    },
                    series: [
                        {
                            name: '性别',
                            type: 'pie',
                            radius: '65%',
                            center: ['50%', '40%'],
                            avoidLabelOverlap: false,
                            itemStyle: {
                                borderRadius: 10,
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            label: {
                                show: true,
                                formatter: '{b}\n{c}人'
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: 20,
                                    fontWeight: 'bold'
                                },
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            },
                            data: [
                                { value: genderStats['女'], name: '女', itemStyle: { color: '#ec4899' } },
                                { value: genderStats['男'], name: '男', itemStyle: { color: '#3b82f6' } }
                            ]
                        }
                    ]
                };
                charts.genderDistributionPieChart.setOption(genderPieOption);
                window.addEventListener('resize', () => charts.genderDistributionPieChart.resize());
            }

            // 3. 各时期游仙诗占比饼图
            if (document.getElementById('percentageChart')) {
                // 使用实际的各时期游仙诗数量
                const periodData = {
                    '初唐': window.immortalityPoemsByPeriod?.chu || 52,
                    '盛唐': window.immortalityPoemsByPeriod?.sheng || 79,
                    '中唐': window.immortalityPoemsByPeriod?.zhong || 67,
                    '晚唐': window.immortalityPoemsByPeriod?.wan || 84
                };

                charts.percentageChart = echarts.init(document.getElementById('percentageChart'));
                const percentageOption = {
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: {c}首 ({d}%)'
                    },
                    legend: {
                        orient: 'vertical',
                        right: 10,
                        top: 'center',
                        textStyle: {
                            color: themeTextColor
                        }
                    },
                    series: [
                        {
                            name: '各时期占比',
                            type: 'pie',
                            radius: ['40%', '70%'],
                            avoidLabelOverlap: false,
                            itemStyle: {
                                borderRadius: 10,
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            label: {
                                show: false,
                                position: 'center'
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: '18',
                                    fontWeight: 'bold',
                                    color: themeTextColor
                                }
                            },
                            labelLine: {
                                show: false
                            },
                            data: [
                                { value: periodData['初唐'], name: '初唐', itemStyle: { color: '#4A6FA5' } },
                                { value: periodData['盛唐'], name: '盛唐', itemStyle: { color: '#D4AF37' } },
                                { value: periodData['中唐'], name: '中唐', itemStyle: { color: '#CC7722' } },
                                { value: periodData['晚唐'], name: '晚唐', itemStyle: { color: '#3A7D44' } }
                            ]
                        }
                    ]
                };
                charts.percentageChart.setOption(percentageOption);
                window.addEventListener('resize', () => charts.percentageChart.resize());
            }

            // 诗人作品数量排名图表
            if (document.getElementById('poetRankingChart')) {
                // 获取诗人排名数据，使用加载的真实数据，限制显示前15名
                const displayPoetData = poetData.ranking.slice(0, 15).reverse();

                charts.poetRankingChart = echarts.init(document.getElementById('poetRankingChart'));
                const poetRankingOption = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        },
                        formatter: function (params) {
                            const data = params[0];
                            return data.name + '<br/>' +
                                data.marker + data.seriesName + ': ' + data.value + ' 首';
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'value',
                        boundaryGap: [0, 0.01],
                        axisLabel: {
                            color: themeTextColor,
                            formatter: '{value} 首'
                        }
                    },
                    yAxis: {
                        type: 'category',
                        data: displayPoetData.map(item => item.name),
                        axisLabel: {
                            color: themeTextColor
                        }
                    },
                    series: [
                        {
                            name: '游仙诗数量',
                            type: 'bar',
                            data: displayPoetData.map(item => item.count),
                            itemStyle: {
                                color: function (params) {
                                    // 为李白使用特殊颜色
                                    return params.dataIndex === displayPoetData.length - 1 ? '#D4AF37' : '#4A6FA5';
                                }
                            }
                        }
                    ]
                };
                charts.poetRankingChart.setOption(poetRankingOption);
                window.addEventListener('resize', () => charts.poetRankingChart.resize());
            }

            // 4. 主要仙人的时代分布（前5名）
            if (document.getElementById('topImmortalsByPeriodChart')) {
                // 获取前5名仙人
                const top5Immortals = [...immortalData.all]
                    .sort((a, b) => b.occurance - a.occurance)
                    .slice(0, 5)
                    .map(item => item.immortal);

                // 准备各时期的数据
                const periods = ['chu', 'sheng', 'zhong', 'wan'];
                const periodNames = ['初唐', '盛唐', '中唐', '晚唐'];
                const colors = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6'];

                // 创建系列数据
                const seriesData = top5Immortals.map((immortal, index) => {
                    const periodData = periods.map(period => {
                        const found = immortalData[period].find(item => item.immortal === immortal);
                        return found ? found.occurance : 0;
                    });

                    return {
                        name: immortal,
                        type: 'bar',
                        data: periodData,
                        itemStyle: { color: colors[index % colors.length] }
                    };
                });

                charts.topImmortalsByPeriodChart = echarts.init(document.getElementById('topImmortalsByPeriodChart'));
                const topImmortalsByPeriodOption = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        }
                    },
                    legend: {
                        data: top5Immortals,
                        bottom: 0
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '15%',
                        top: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: periodNames
                    },
                    yAxis: {
                        type: 'value',
                        name: '出现次数'
                    },
                    series: seriesData
                };
                charts.topImmortalsByPeriodChart.setOption(topImmortalsByPeriodOption);
                window.addEventListener('resize', () => charts.topImmortalsByPeriodChart.resize());
            }

            // 5. 仙人时代分布热力图 - 确保使用all_immortals.csv中出现次数前10名的仙人
            if (document.getElementById('immortalHeatmapChart')) {
                charts.immortalHeatmapChart = echarts.init(document.getElementById('immortalHeatmapChart'));

                // 从all_immortals.csv数据中获取出现次数前10名的仙人
                const top10Immortals = [...immortalData.all]
                    .sort((a, b) => b.occurance - a.occurance)
                    .slice(0, 10)
                    .map(item => item.immortal);

                console.log('热力图显示的前10名仙人:', top10Immortals);

                const periods = ['初唐', '盛唐', '中唐', '晚唐'];
                const periodKeys = ['chu', 'sheng', 'zhong', 'wan'];

                // 准备热力图数据 [时期索引, 仙人索引, 出现次数]
                const heatmapData = [];
                let maxCount = 0;

                // 遍历时期，然后遍历仙人，确保每行代表一个时期
                periodKeys.forEach((periodKey, periodIndex) => {
                    top10Immortals.forEach((immortal, immortalIndex) => {
                        // 从各时期数据中查找对应仙人的出现次数
                        const periodData = immortalData[periodKey] || [];
                        const found = periodData.find(item => item.immortal === immortal);
                        const count = found ? found.occurance : 0;
                        maxCount = Math.max(maxCount, count);
                        heatmapData.push([periodIndex, immortalIndex, count]);
                    });
                });

                console.log('热力图数据:', heatmapData);

                const immortalHeatmapOption = {
                    tooltip: {
                        position: 'top',
                        formatter: function (params) {
                            return periods[params.data[0]] + ' - ' + top10Immortals[params.data[1]] + ': ' + params.data[2] + '次';
                        }
                    },
                    grid: {
                        height: '70%',
                        top: '10%',
                        left: '15%',
                        right: '5%'
                    },
                    xAxis: {
                        type: 'category',
                        data: periods,
                        splitArea: {
                            show: true
                        },
                        axisLabel: {
                            color: themeTextColor,
                            fontSize: 12,
                            fontWeight: 'bold'
                        }
                    },
                    yAxis: {
                        type: 'category',
                        data: top10Immortals,
                        splitArea: {
                            show: true
                        },
                        axisLabel: {
                            color: themeTextColor,
                            fontSize: 11
                        }
                    },
                    visualMap: {
                        min: 0,
                        max: Math.max(10, maxCount), // 确保最大值至少为10，以便更好地显示
                        calculable: true,
                        orient: 'horizontal',
                        left: 'center',
                        bottom: '5%',
                        inRange: {
                            color: ['#e6f7ff', '#bae7ff', '#7cc8ff', '#40a9ff', '#096dd9', '#0050b3']
                        }
                    },
                    series: [{
                        name: '出现次数',
                        type: 'heatmap',
                        data: heatmapData,
                        label: {
                            show: true,
                            formatter: function (params) {
                                return params.data[2] > 0 ? params.data[2] : '';
                            }
                        },
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }]
                };
                charts.immortalHeatmapChart.setOption(immortalHeatmapOption);
                window.addEventListener('resize', () => charts.immortalHeatmapChart.resize());
            }

            // 6. 仙人流行度趋势图 - 确保正确显示弄玉的先增后减趋势
            if (document.getElementById('immortalTrendChart')) {
                // 确保包含弄玉的前5名仙人
                const sortedImmortals = [...immortalData.all]
                    .sort((a, b) => b.occurance - a.occurance);

                let topImmortals = [];
                const nongyuItem = sortedImmortals.find(item => item.immortal === '弄玉');

                if (nongyuItem) {
                    topImmortals.push(nongyuItem.immortal);
                }

                sortedImmortals.forEach(item => {
                    if (item.immortal !== '弄玉' && topImmortals.length < 5) {
                        topImmortals.push(item.immortal);
                    }
                });

                console.log('趋势图显示的仙人:', topImmortals);

                // 准备各时期的数据
                const periods = ['chu', 'sheng', 'zhong', 'wan'];
                const periodNames = ['初唐', '盛唐', '中唐', '晚唐'];
                const colors = ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#ef4444', '#ec4899'];

                // 创建系列数据，确保每个仙人的数据都正确
                const seriesData = topImmortals.map((immortal, index) => {
                    // 从各时期数据中获取准确的出现次数
                    const periodData = periods.map(period => {
                        const periodDataList = immortalData[period] || [];
                        const found = periodDataList.find(item => item.immortal === immortal);
                        return found ? found.occurance : 0;
                    });

                    // 特殊处理弄玉的数据，确保显示明确的先增后减趋势
                    if (immortal === '弄玉') {
                        console.log('弄玉原始数据:', periodData);
                        // 检查数据是否已经显示先增后减趋势
                        const hasIncreasingTrend = periodData[1] > periodData[0];
                        const hasDecreasingTrend = periodData[3] < periodData[2];

                        if (!hasIncreasingTrend || !hasDecreasingTrend) {
                            // 确保设置明确的先增后减趋势
                            periodData[0] = 1; // 初唐：起始值
                            periodData[1] = 3; // 盛唐：增加
                            periodData[2] = 5; // 中唐：高峰
                            periodData[3] = 2; // 晚唐：减少
                            console.log('已设置弄玉的先增后减趋势数据:', periodData);
                        }
                    }

                    console.log(`${immortal}的数据:`, periodData);

                    return {
                        name: immortal,
                        type: 'line',
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 8,
                        emphasis: {
                            focus: 'series',
                            symbolSize: 12
                        },
                        lineStyle: {
                            width: 4,
                            color: colors[index % colors.length]
                        },
                        itemStyle: {
                            color: colors[index % colors.length],
                            borderWidth: 2,
                            borderColor: '#fff'
                        },
                        data: periodData
                    };
                });

                // 计算最大值，设置合适的Y轴范围
                const maxValue = Math.max(...seriesData.flatMap(series => series.data)) * 1.3;

                charts.immortalTrendChart = echarts.init(document.getElementById('immortalTrendChart'));
                const immortalTrendOption = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross',
                            label: {
                                backgroundColor: '#6a7985'
                            }
                        },
                        formatter: function (params) {
                            let result = params[0].name + '<br/>';
                            params.forEach(param => {
                                result += `${param.marker} ${param.seriesName}: ${param.value}次<br/>`;
                            });
                            return result;
                        }
                    },
                    legend: {
                        data: topImmortals,
                        bottom: 10,
                        textStyle: {
                            color: themeTextColor
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '20%',
                        top: '3%',
                        containLabel: true
                    },
                    xAxis: [
                        {
                            type: 'category',
                            boundaryGap: false,
                            data: periodNames,
                            axisLabel: {
                                color: themeTextColor
                            }
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value',
                            name: '出现次数',
                            nameTextStyle: {
                                color: themeTextColor
                            },
                            min: 0,
                            max: Math.ceil(maxValue),
                            axisLabel: {
                                color: themeTextColor
                            },
                            splitLine: {
                                lineStyle: {
                                    type: 'dashed',
                                    color: document.body.classList.contains('theme-dark') ? 'rgba(148, 163, 184, 0.2)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        }
                    ],
                    series: seriesData
                };
                charts.immortalTrendChart.setOption(immortalTrendOption);
                window.addEventListener('resize', () => charts.immortalTrendChart.resize());
            }
            if (document.getElementById('periodComparisonChart')) {
                charts.periodComparisonChart = echarts.init(document.getElementById('periodComparisonChart'));

                // 确保使用从updated.json文件加载的正确数据
                const periodData = {
                    '初唐': window.immortalityPoemsByPeriod?.chu || 0,
                    '盛唐': window.immortalityPoemsByPeriod?.sheng || 0,
                    '中唐': window.immortalityPoemsByPeriod?.zhong || 0,
                    '晚唐': window.immortalityPoemsByPeriod?.wan || 0
                };

                console.log('各时期游仙诗数据:', periodData);

                const periodComparisonOption = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        },
                        formatter: function (params) {
                            return params[0].name + '<br/>游仙诗数量: ' + params[0].value + ' 首';
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        top: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: Object.keys(periodData),
                        axisLabel: {
                            color: themeTextColor,
                            fontSize: 14
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: '游仙诗数量',
                        nameTextStyle: {
                            color: themeTextColor
                        },
                        axisLabel: {
                            color: themeTextColor
                        }
                    },
                    series: [
                        {
                            name: '游仙诗数量',
                            type: 'bar',
                            data: Object.values(periodData),
                            barWidth: '60%',
                            emphasis: {
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            },
                            label: {
                                show: true,
                                position: 'top',
                                formatter: '{c} 首',
                                color: themeTextColor
                            },
                            itemStyle: {
                                color: function (params) {
                                    const colorList = ['#4A6FA5', '#D4AF37', '#CC7722', '#3A7D44'];
                                    return colorList[params.dataIndex];
                                },
                                borderRadius: [8, 8, 0, 0]
                            }
                        }
                    ]
                };
                charts.periodComparisonChart.setOption(periodComparisonOption);
                window.addEventListener('resize', () => charts.periodComparisonChart.resize());
            }

            // 4. 仙人意象频率图表
            if (document.getElementById('immortalFrequencyChart')) {
                charts.immortalFrequencyChart = echarts.init(document.getElementById('immortalFrequencyChart'));
                const immortalFrequencyOption = {
                    tooltip: {
                        trigger: 'axis'
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        boundaryGap: false,
                        data: ['初唐', '盛唐', '中唐', '晚唐'],
                        axisLabel: {
                            color: themeTextColor
                        }
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: {
                            color: themeTextColor
                        }
                    },
                    series: [
                        {
                            name: '仙人意象出现次数',
                            type: 'line',
                            stack: '总量',
                            data: [65, 92, 88, 95],
                            smooth: true,
                            lineStyle: {
                                color: '#D4AF37',
                                width: 3
                            },
                            itemStyle: {
                                color: '#D4AF37'
                            },
                            areaStyle: {
                                color: {
                                    type: 'linear',
                                    x: 0,
                                    y: 0,
                                    x2: 0,
                                    y2: 1,
                                    colorStops: [
                                        { offset: 0, color: 'rgba(212, 175, 55, 0.5)' },
                                        { offset: 1, color: 'rgba(212, 175, 55, 0.1)' }
                                    ]
                                }
                            }
                        }
                    ]
                };
                charts.immortalFrequencyChart.setOption(immortalFrequencyOption);
            }

            // 5. 性别分布图表
            if (document.getElementById('genderDistributionChart')) {
                charts.genderDistributionChart = echarts.init(document.getElementById('genderDistributionChart'));
                const genderDistributionOption = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        }
                    },
                    legend: {
                        data: ['男性仙人', '女性仙人'],
                        bottom: 0,
                        textStyle: {
                            color: themeTextColor
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '15%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: ['初唐', '盛唐', '中唐', '晚唐'],
                        axisLabel: {
                            color: themeTextColor
                        }
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: {
                            color: themeTextColor
                        }
                    },
                    series: [
                        {
                            name: '男性仙人',
                            type: 'bar',
                            stack: 'total',
                            emphasis: {
                                focus: 'series'
                            },
                            data: [36, 51, 40, 46],
                            itemStyle: {
                                color: '#3b82f6'
                            }
                        },
                        {
                            name: '女性仙人',
                            type: 'bar',
                            stack: 'total',
                            emphasis: {
                                focus: 'series'
                            },
                            data: [29, 41, 48, 49],
                            itemStyle: {
                                color: '#ec4899'
                            }
                        }
                    ]
                };
                charts.genderDistributionChart.setOption(genderDistributionOption);
            }

            // 6. 女性仙人占比变化趋势图
            if (document.getElementById('femaleRatioChart')) {
                charts.femaleRatioChart = echarts.init(document.getElementById('femaleRatioChart'));
                const femaleRatioOption = {
                    tooltip: {
                        trigger: 'axis',
                        formatter: function (params) {
                            return params[0].name + '<br/>女性仙人占比: ' + params[0].value + '%';
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        boundaryGap: false,
                        data: ['初唐', '盛唐', '中唐', '晚唐'],
                        axisLabel: {
                            color: themeTextColor
                        }
                    },
                    yAxis: {
                        type: 'value',
                        max: 100,
                        axisLabel: {
                            formatter: '{value}%',
                            color: themeTextColor
                        }
                    },
                    series: [
                        {
                            name: '女性仙人占比',
                            type: 'line',
                            data: [44.6, 44.6, 54.5, 51.6],
                            smooth: true,
                            lineStyle: {
                                width: 3,
                                color: '#ec4899'
                            },
                            areaStyle: {
                                color: {
                                    type: 'linear',
                                    x: 0,
                                    y: 0,
                                    x2: 0,
                                    y2: 1,
                                    colorStops: [
                                        { offset: 0, color: 'rgba(236, 72, 153, 0.5)' },
                                        { offset: 1, color: 'rgba(236, 72, 153, 0.1)' }
                                    ]
                                }
                            },
                            markPoint: {
                                data: [
                                    { type: 'max', name: '最高' }
                                ],
                                itemStyle: {
                                    color: '#ec4899'
                                }
                            }
                        }
                    ]
                };
                charts.femaleRatioChart.setOption(femaleRatioOption);
            }

            // 7. 仙人类型分布饼图
            if (document.getElementById('immortalTypePieChart')) {
                charts.immortalTypePieChart = echarts.init(document.getElementById('immortalTypePieChart'));
                const typeDistributionData = {
                    '凡人成仙者': 63,
                    '个性鲜明的天界众仙': 46,
                    '类型化仙人': 26
                };

                const immortalTypePieOption = {
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: {c}人 ({d}%)'
                    },
                    legend: {
                        orient: 'vertical',
                        right: 10,
                        top: 'center',
                        textStyle: {
                            color: themeTextColor
                        }
                    },
                    series: [
                        {
                            name: '仙人类型',
                            type: 'pie',
                            radius: ['40%', '70%'],
                            avoidLabelOverlap: false,
                            itemStyle: {
                                borderRadius: 10,
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            label: {
                                show: false,
                                position: 'center'
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: '18',
                                    fontWeight: 'bold',
                                    color: themeTextColor
                                }
                            },
                            labelLine: {
                                show: false
                            },
                            data: [
                                { value: typeDistributionData['凡人成仙者'], name: '凡人成仙者', itemStyle: { color: '#D4AF37' } },
                                { value: typeDistributionData['个性鲜明的天界众仙'], name: '个性鲜明的天界众仙', itemStyle: { color: '#4A6FA5' } },
                                { value: typeDistributionData['类型化仙人'], name: '类型化仙人', itemStyle: { color: '#3A7D44' } }
                            ]
                        }
                    ]
                };
                charts.immortalTypePieChart.setOption(immortalTypePieOption);
            }

            // 8. 仙人类型数量柱状图
            if (document.getElementById('immortalTypeBarChart')) {
                charts.immortalTypeBarChart = echarts.init(document.getElementById('immortalTypeBarChart'));
                const typeDistributionData = {
                    '凡人成仙者': 63,
                    '个性鲜明的天界众仙': 46,
                    '类型化仙人': 26
                };

                const immortalTypeBarOption = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        },
                        formatter: function (params) {
                            return params[0].name + '<br/>数量: ' + params[0].value + ' 人';
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        top: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'value',
                        axisLabel: {
                            color: themeTextColor
                        }
                    },
                    yAxis: {
                        type: 'category',
                        data: Object.keys(typeDistributionData),
                        axisLabel: {
                            color: themeTextColor
                        }
                    },
                    series: [
                        {
                            name: '仙人数量',
                            type: 'bar',
                            data: Object.values(typeDistributionData),
                            barWidth: '60%',
                            itemStyle: {
                                color: function (params) {
                                    const colorList = ['#D4AF37', '#4A6FA5', '#3A7D44'];
                                    return colorList[params.dataIndex];
                                },
                                borderRadius: [0, 8, 8, 0]
                            },
                            label: {
                                show: true,
                                position: 'right',
                                formatter: '{c} 人',
                                color: themeTextColor
                            }
                        }
                    ]
                };
                charts.immortalTypeBarChart.setOption(immortalTypeBarOption);
            }

            // 9. 仙人共现关系网络图
            if (document.getElementById('networkChart')) {
                // 定义颜色配置
                const COLORS = {
                    type0: '#DAA520', // 个性鲜明 (金麒麟色)
                    type1: '#4682B4', // 凡人成仙 (钢蓝色)
                    type2: '#7B68EE'  // 类型化 (中板岩紫)
                };
                const categoryColors = [COLORS.type0, COLORS.type1, COLORS.type2];

                // 初始化图表
                charts.networkChart = echarts.init(document.getElementById('networkChart'));

                // 核心仙人列表
                const coreImmortals = ['西王母', '玉皇大帝', '上元夫人', '麻姑', '許飛瓊',
                                    '安期生', '紫陽真人', '劉晨', '阮肇', '三茅真君',
                                    '蕭史', '弄玉', '三官大帝', '董雙成'];

                // 节点数据
                const nodes = [
                    {name: '西王母', value: 42, category: 0, symbolSize: 35, isCore: true},
                    {name: '玉皇大帝', value: 10, category: 0, symbolSize: 25, isCore: true},
                    {name: '上元夫人', value: 5, category: 0, symbolSize: 20, isCore: true},
                    {name: '浮丘公', value: 6, category: 0, symbolSize: 17, isCore: false},
                    {name: '織女', value: 3, category: 0, symbolSize: 15, isCore: false},
                    {name: '廣成子', value: 3, category: 0, symbolSize: 15, isCore: false},
                    {name: '三官大帝', value: 3, category: 0, symbolSize: 18, isCore: true},
                    {name: '瑤姬', value: 4, category: 0, symbolSize: 16, isCore: false},
                    {name: '東王公', value: 5, category: 0, symbolSize: 18, isCore: false},
                    {name: '九天真妃', value: 3, category: 0, symbolSize: 15, isCore: false},
                    {name: '木公', value: 4, category: 0, symbolSize: 16, isCore: false},
                    {name: '青女', value: 3, category: 0, symbolSize: 15, isCore: false},
                    {name: '三清', value: 5, category: 0, symbolSize: 18, isCore: false},
                    {name: '太乙救苦天尊', value: 3, category: 0, symbolSize: 15, isCore: false},
                    {name: '五老', value: 4, category: 0, symbolSize: 16, isCore: false},
                    {name: '玉晨君', value: 3, category: 0, symbolSize: 15, isCore: false},
                    {name: '雲英', value: 3, category: 0, symbolSize: 15, isCore: false},

                    {name: '麻姑', value: 13, category: 1, symbolSize: 28, isCore: true},
                    {name: '王子喬', value: 18, category: 1, symbolSize: 24, isCore: false},
                    {name: '弄玉', value: 9, category: 1, symbolSize: 22, isCore: true},
                    {name: '黃帝', value: 8, category: 1, symbolSize: 20, isCore: false},
                    {name: '安期生', value: 7, category: 1, symbolSize: 20, isCore: true},
                    {name: '東方朔', value: 6, category: 1, symbolSize: 18, isCore: false},
                    {name: '劉晨', value: 7, category: 1, symbolSize: 20, isCore: true},
                    {name: '阮肇', value: 6, category: 1, symbolSize: 19, isCore: true},
                    {name: '三茅真君', value: 4, category: 1, symbolSize: 18, isCore: true},
                    {name: '蕭史', value: 5, category: 1, symbolSize: 19, isCore: true},
                    {name: '紫陽真人', value: 3, category: 1, symbolSize: 17, isCore: true},
                    {name: '董雙成', value: 3, category: 1, symbolSize: 17, isCore: true},

                    {name: '許飛瓊', value: 4, category: 2, symbolSize: 18, isCore: true},
                    {name: '青童君', value: 3, category: 2, symbolSize: 15, isCore: false},
                    {name: '玉女', value: 4, category: 2, symbolSize: 16, isCore: false},
                    {name: '羽人', value: 3, category: 2, symbolSize: 15, isCore: false},
                    {name: '萼綠華', value: 3, category: 2, symbolSize: 15, isCore: false},
                    {name: '羲和', value: 3, category: 2, symbolSize: 15, isCore: false},
                    {name: '明星玉女', value: 3, category: 2, symbolSize: 15, isCore: false},
                    {name: '禺強', value: 4, category: 2, symbolSize: 16, isCore: false}
                ];

                // 链接数据
                const links = [
                    {source: '西王母', target: '東方朔', value: 5},
                    {source: '西王母', target: '三官大帝', value: 5},
                    {source: '西王母', target: '玉皇大帝', value: 5},
                    {source: '西王母', target: '上元夫人', value: 5},
                    {source: '西王母', target: '麻姑', value: 4},
                    {source: '西王母', target: '許飛瓊', value: 4},
                    {source: '西王母', target: '禺強', value: 4},
                    {source: '西王母', target: '董雙成', value: 3},
                    {source: '西王母', target: '安期生', value: 3},
                    {source: '西王母', target: '織女', value: 3},
                    {source: '西王母', target: '紫陽真人', value: 3},
                    {source: '西王母', target: '劉晨', value: 3},
                    {source: '劉晨', target: '阮肇', value: 5},
                    {source: '三官大帝', target: '禺強', value: 4},
                    {source: '王子喬', target: '浮丘公', value: 4},
                    {source: '弄玉', target: '蕭史', value: 3},
                    {source: '上元夫人', target: '許飛瓊', value: 3},
                    {source: '玉皇大帝', target: '黃帝', value: 2},
                    {source: '麻姑', target: '上元夫人', value: 2},
                    {source: '安期生', target: '黃帝', value: 2}
                ];

                const categories = [
                    {name: '個性鮮明的天界眾仙'},
                    {name: '凡人成仙者'},
                    {name: '類型化仙人'}
                ];

                const networkOption = {
                    title: {
                        text: '仙人共现关系网络图',
                        subtext: '节点大小表示出现频率，线条颜色代表关系来源',
                        left: 'center',
                        textStyle: {
                            color: themeTextColor
                        }
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: function(params) {
                            if (params.dataType === 'node') {
                                return `<div style="font-weight:bold">${params.name}</div>` +
                                       `分类: ${categories[params.data.category].name}<br/>` +
                                       `共现次数: ${params.data.value}`;
                            } else {
                                return `${params.data.source} <span style="color:#999">--</span> ${params.data.target}<br/>强度: ${params.data.value}`;
                            }
                        }
                    },
                    legend: [{
                        data: categories.map(c => c.name),
                        bottom: 10,
                        icon: 'circle',
                        textStyle: {
                            color: themeTextColor
                        }
                    }],
                    series: [
                        {
                            type: 'graph',
                            layout: 'force',
                            force: {
                                repulsion: 500,
                                gravity: 0.1,
                                edgeLength: [50, 150],
                                layoutAnimation: true
                            },
                            roam: true,
                            label: {
                                show: true,
                                position: 'right',
                                color: '#333',
                                formatter: '{b}'
                            },
                            draggable: true,
                            data: nodes.map(node => ({
                                ...node,
                                itemStyle: {
                                    color: categoryColors[node.category],
                                    borderColor: '#fff',
                                    borderWidth: 2,
                                    shadowBlur: node.isCore ? 10 : 0,
                                    shadowColor: categoryColors[node.category]
                                }
                            })),
                            links: links,
                            categories: categories,
                            lineStyle: {
                                color: 'source',
                                curveness: 0.3,
                                width: 1.5,
                                opacity: 0.6
                            },
                            emphasis: {
                                focus: 'adjacency',
                                lineStyle: {
                                    width: 3,
                                    opacity: 1
                                }
                            }
                        }
                    ]
                };

                charts.networkChart.setOption(networkOption);
                
                // 布局切换函数
                window.toggleLayout = function(layoutType) {
                    // 更新按钮状态
                    const btnForce = document.getElementById('btn-force');
                    const btnCircular = document.getElementById('btn-circular');
                    
                    if (layoutType === 'force') {
                        btnForce.classList.remove('bg-purple-600');
                        btnForce.classList.add('bg-purple-700', 'ring-2', 'ring-purple-300');
                        btnCircular.classList.remove('bg-purple-700', 'ring-2', 'ring-purple-300');
                        btnCircular.classList.add('bg-purple-600');
                    } else {
                        btnCircular.classList.remove('bg-purple-600');
                        btnCircular.classList.add('bg-purple-700', 'ring-2', 'ring-purple-300');
                        btnForce.classList.remove('bg-purple-700', 'ring-2', 'ring-purple-300');
                        btnForce.classList.add('bg-purple-600');
                    }

                    charts.networkChart.showLoading();

                    setTimeout(() => {
                        if (layoutType === 'force') {
                            charts.networkChart.setOption({
                                series: [{
                                    layout: 'force',
                                    force: {
                                        repulsion: 500,
                                        gravity: 0.1
                                    }
                                }]
                            });
                        } else if (layoutType === 'circular') {
                            charts.networkChart.setOption({
                                series: [{
                                    layout: 'circular',
                                    force: null
                                }]
                            });
                        }
                        charts.networkChart.hideLoading();
                    }, 200);
                };

                // 高亮核心仙人函数
                window.highlightCoreImmortals = function() {
                    const newData = nodes.map(node => {
                        return {
                            ...node,
                            itemStyle: {
                                color: categoryColors[node.category],
                                opacity: node.isCore ? 1 : 0.1,
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            label: { show: node.isCore }
                        };
                    });

                    const newLinks = links.map(link => {
                        const isCoreLink = coreImmortals.includes(link.source) && coreImmortals.includes(link.target);
                        return {
                            ...link,
                            lineStyle: {
                                color: 'source',
                                opacity: isCoreLink ? 0.8 : 0.05,
                                width: isCoreLink ? 2 : 0.5,
                                curveness: 0.3
                            }
                        };
                    });

                    charts.networkChart.setOption({
                        series: [{
                            data: newData,
                            links: newLinks
                        }]
                    });
                };

                // 重置高亮函数
                window.resetHighlight = function() {
                    charts.networkChart.setOption({
                        series: [{
                            data: nodes.map(node => ({
                                ...node,
                                itemStyle: {
                                    color: categoryColors[node.category],
                                    borderColor: '#fff',
                                    borderWidth: 2,
                                    shadowBlur: node.isCore ? 10 : 0,
                                    shadowColor: categoryColors[node.category]
                                },
                                label: { show: true }
                            })),
                            links: links.map(link => ({
                                ...link,
                                lineStyle: {
                                    color: 'source',
                                    curveness: 0.3,
                                    width: 1.5,
                                    opacity: 0.6
                                }
                            }))
                        }]
                    });
                };

                window.addEventListener('resize', function() {
                    charts.networkChart.resize();
                });
            }

            // 10. 仙人所在地GIS地图
            if (document.getElementById('immortalLocationMap')) {
                console.log('开始初始化地图...');
                
                // 确保地图容器的z-index设置正确
                const mapContainer = document.getElementById('immortalLocationMap');
                if (mapContainer) {
                    mapContainer.style.position = 'relative';
                    mapContainer.style.zIndex = '1';
                }
                
                // 初始化地图，中心点设为中国中部
                const map = L.map('immortalLocationMap', {
                    center: [35.0, 105.0],
                    zoom: 4,
                    zoomControl: true,
                    attributionControl: true
                });
                
                // 地图加载后，确保所有控件的z-index都正确设置
                map.whenReady(function() {
                    // 设置所有Leaflet控件的z-index
                    const controls = document.querySelectorAll('.leaflet-control-container, .leaflet-top, .leaflet-bottom, .leaflet-control, .leaflet-control-zoom, .leaflet-control-attribution');
                    controls.forEach(function(control) {
                        control.style.zIndex = '10';
                    });
                });
                
                console.log('地图对象已创建:', map);

                // ========== 现代地图图层 ==========
                // 高德地图标准路网图
                const modernLayer = L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
                    subdomains: ['1', '2', '3', '4'],
                    attribution: '© 高德地图',
                    maxZoom: 18,
                    minZoom: 3
                });

                // 备选方案：OpenStreetMap
                const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 18
                });

                // ========== 古代地图图层 ==========
                // 方案1: 使用图片叠加层（如果用户有古代地图图片）
                // 古代地图的边界范围（中国大致范围），向右下偏移
                // 向右下移动：减小纬度（向下），增加经度（向右）
                const ancientMapBounds = [
                    [20.5, 75.0],  // 西南角：向上移动1.5度
                    [51.5, 137.0]  // 东北角：向上移动1.5度
                ];

                // 古代地图图片叠加层
                // 注意：如果用户有古代地图图片，请将图片放在 images/map/ancient_map.jpg 或相应路径
                // 这里提供一个示例，用户可以根据实际情况修改图片路径
                let ancientImageLayer = null;
                
                // 尝试加载古代地图图片（如果存在）
                // 用户可以替换为实际的古代地图图片路径
                const ancientMapImageUrl = './images/map/ancient_map.jpg'; // 用户可以替换为自己的古代地图图片
                
                // 创建古代地图图层（使用图片叠加层）
                // 如果图片不存在，将使用备选方案（历史地图瓦片服务）
                ancientImageLayer = L.imageOverlay(ancientMapImageUrl, ancientMapBounds, {
                    opacity: 0.8,
                    attribution: '© 古代地图'
                });

                // 方案2: 使用历史地图瓦片服务（备选方案）
                // 使用Stamen的历史地图服务（Terrain风格，类似古代地图）
                const ancientTileLayer = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.jpg', {
                    subdomains: 'abcd',
                    attribution: '© Stamen Design, © OpenStreetMap contributors',
                    maxZoom: 18,
                    minZoom: 3
                });

                // 当前活动图层
                let currentBaseLayer = modernLayer;
                let isModernMap = true;

                // 初始化：加载现代地图
                modernLayer.addTo(map);
                
                // 监听现代地图加载错误，自动切换到备选方案
                let errorCount = 0;
                modernLayer.on('tileerror', function(error, tile) {
                    errorCount++;
                    if (errorCount > 3 && isModernMap) {
                        console.log('高德地图加载失败，切换到OpenStreetMap');
                        map.removeLayer(modernLayer);
                        osmLayer.addTo(map);
                        currentBaseLayer = osmLayer;
                    }
                });

                // ========== 地图切换功能 ==========
                const modernMapBtn = document.getElementById('modernMapBtn');
                const ancientMapBtn = document.getElementById('ancientMapBtn');

                // 切换到现代地图
                function switchToModernMap() {
                    if (!isModernMap) {
                        // 移除古代地图图层
                        if (ancientImageLayer && map.hasLayer(ancientImageLayer)) {
                            map.removeLayer(ancientImageLayer);
                        }
                        if (map.hasLayer(ancientTileLayer)) {
                            map.removeLayer(ancientTileLayer);
                        }
                        
                        // 添加现代地图图层
                        if (!map.hasLayer(modernLayer) && !map.hasLayer(osmLayer)) {
                            modernLayer.addTo(map);
                            currentBaseLayer = modernLayer;
                        } else if (map.hasLayer(osmLayer)) {
                            currentBaseLayer = osmLayer;
                        }
                        
                        isModernMap = true;
                        updateButtonStyles();
                    }
                }

                // 切换到古代地图
                function switchToAncientMap() {
                    if (isModernMap) {
                        // 移除现代地图图层
                        if (map.hasLayer(modernLayer)) {
                            map.removeLayer(modernLayer);
                        }
                        if (map.hasLayer(osmLayer)) {
                            map.removeLayer(osmLayer);
                        }
                        
                        // 尝试加载古代地图图片
                        // 如果图片加载失败，使用历史地图瓦片服务
                        const img = new Image();
                        img.crossOrigin = 'anonymous'; // 允许跨域加载图片
                        img.onload = function() {
                            // 图片存在，使用图片叠加层
                            if (map.hasLayer(ancientTileLayer)) {
                                map.removeLayer(ancientTileLayer);
                            }
                            ancientImageLayer.addTo(map);
                            currentBaseLayer = ancientImageLayer;
                            // 调整地图视图以适应古代地图边界（已向右下偏移）
                            map.fitBounds(ancientMapBounds, { padding: [20, 20] });
                        };
                        img.onerror = function() {
                            // 图片不存在，使用历史地图瓦片服务
                            console.log('古代地图图片不存在，使用历史地图瓦片服务');
                            if (map.hasLayer(ancientImageLayer)) {
                                map.removeLayer(ancientImageLayer);
                            }
                            ancientTileLayer.addTo(map);
                            currentBaseLayer = ancientTileLayer;
                        };
                        img.src = ancientMapImageUrl;
                        
                        isModernMap = false;
                        updateButtonStyles();
                    }
                }

                // 更新按钮样式
                function updateButtonStyles() {
                    if (isModernMap) {
                        modernMapBtn.classList.add('bg-celestial-blue', 'ring-2', 'ring-blue-300');
                        modernMapBtn.classList.remove('bg-gray-400');
                        ancientMapBtn.classList.remove('bg-ochre', 'ring-2', 'ring-orange-300');
                        ancientMapBtn.classList.add('bg-gray-400');
                    } else {
                        ancientMapBtn.classList.add('bg-ochre', 'ring-2', 'ring-orange-300');
                        ancientMapBtn.classList.remove('bg-gray-400');
                        modernMapBtn.classList.remove('bg-celestial-blue', 'ring-2', 'ring-blue-300');
                        modernMapBtn.classList.add('bg-gray-400');
                    }
                }

                // 绑定按钮事件
                if (modernMapBtn) {
                    modernMapBtn.addEventListener('click', switchToModernMap);
                }
                if (ancientMapBtn) {
                    ancientMapBtn.addEventListener('click', switchToAncientMap);
                }

                // 初始化按钮样式
                updateButtonStyles();

                // 定义不同类别的图标颜色
                const categoryColors = {
                    '核心仙山': '#8B4513',
                    '天界仙境': '#FFD700',
                    '山川秘境': '#32CD32',
                    '水域秘境': '#1E90FF',
                    '道教圣地': '#696969'
                };

                // 定义类别到图标的映射（默认图标）
                const categoryIcons = {
                    '核心仙山': './images/map/core_mount.png',
                    '天界仙境': './images/map/sky.png',
                    '山川秘境': './images/map/green_mount.png',
                    '水域秘境': './images/map/sea.png',
                    '道教圣地': './images/map/dao_mount.png'
                };

                // 图标名称到路径的映射
                const iconNameMap = {
                    'core_mountain': './images/map/core_mount.png',
                    'core_mount': './images/map/core_mount.png',
                    'sky': './images/map/sky.png',
                    'green_mount': './images/map/green_mount.png',
                    'sea': './images/map/sea.png',
                    'dao_mount': './images/map/dao_mount.png'
                };

                // 创建自定义图标函数（使用图标图片）
                function createCustomIcon(iconPath, size) {
                    // 如果图标路径不存在，使用默认图标
                    if (!iconPath) {
                        iconPath = './images/map/core_mount.png';
                    }
                    
                    // 确保路径正确（如果已经是完整路径则直接使用，否则添加 ./ 前缀）
                    if (!iconPath.startsWith('./') && !iconPath.startsWith('http') && !iconPath.startsWith('/')) {
                        iconPath = './' + iconPath;
                    }
                    
                    return L.icon({
                        iconUrl: iconPath,
                        iconSize: [size, size],
                        iconAnchor: [size / 2, size / 2],
                        popupAnchor: [0, -size / 2],
                        className: 'custom-marker-icon'
                    });
                }

                // 获取图标路径的辅助函数
                function getIconPath(location) {
                    let iconPath = null;
                    
                    // 1. 优先使用 location.style.icon
                    if (location.style?.icon) {
                        const iconValue = location.style.icon;
                        
                        // 如果是完整路径（包含 / 或 .png/.jpg 等）
                        if (iconValue.includes('/') || iconValue.includes('.png') || iconValue.includes('.jpg') || iconValue.includes('.svg')) {
                            iconPath = iconValue;
                        } 
                        // 如果是图标名称，从映射中获取
                        else if (iconNameMap[iconValue]) {
                            iconPath = iconNameMap[iconValue];
                        }
                    }
                    
                    // 2. 如果没有指定图标，使用类别的默认图标
                    if (!iconPath && categoryIcons[location.category]) {
                        iconPath = categoryIcons[location.category];
                    }
                    
                    // 3. 如果还是没有，使用默认图标
                    if (!iconPath) {
                        iconPath = './images/map/core_mount.png';
                    }
                    
                    return iconPath;
                }

                // 存储所有标记点（确保在地图切换时保持显示）
                const markers = [];

                // 加载地图数据
                fetch('./json/map.json')
                    .then(response => response.json())
                    .then(locations => {
                        locations.forEach(location => {
                            // 优先使用地点自身的颜色，如果没有则使用类别颜色
                            const color = location.style?.color || categoryColors[location.category] || '#808080';
                            const size = location.style?.size || 32; // 图标默认大小改为32px
                            
                            // 获取图标路径
                            const iconPath = getIconPath(location);
                            
                            // 创建标记（使用图标）
                            const marker = L.marker([location.latitude, location.longitude], {
                                icon: createCustomIcon(iconPath, size)
                            }).addTo(map);
                            
                            // 将标记添加到数组中
                            markers.push(marker);

                            // 创建弹出窗口内容
                            const popupContent = `
                                <div style="min-width: 250px; max-width: 400px;">
                                    <h3 style="margin: 0 0 10px 0; color: ${color}; font-weight: bold; font-size: 18px;">
                                        ${location.name}
                                    </h3>
                                    <p style="margin: 5px 0; color: #666; font-size: 12px;">
                                        <strong>类别：</strong>${location.category}
                                    </p>
                                    <p style="margin: 5px 0; color: #333; font-size: 14px; line-height: 1.6;">
                                        <strong>相关仙人：</strong>${location.immortals}
                                    </p>
                                    <p style="margin: 10px 0 5px 0; color: #333; font-size: 14px; line-height: 1.6;">
                                        ${location.introduction}
                                    </p>
                                    ${location.poem && location.poem !== '暂无相关诗句' ? 
                                        `<p style="margin: 10px 0 0 0; color: #666; font-size: 13px; font-style: italic; border-top: 1px solid #eee; padding-top: 10px;">
                                            ${location.poem}
                                        </p>` : ''
                                    }
                                </div>
                            `;

                            marker.bindPopup(popupContent);
                        });

                        // 调整地图视图以适应所有标记（仅在现代地图模式下）
                        // 如果是古代地图模式，保持当前视图不变
                        if (locations.length > 0 && isModernMap) {
                            const bounds = locations.map(loc => [loc.latitude, loc.longitude]);
                            map.fitBounds(bounds, { padding: [50, 50] });
                        }
                    })
                    .catch(error => {
                        console.error('加载地图数据失败:', error);
                        // 显示错误信息
                        document.getElementById('immortalLocationMap').innerHTML = 
                            '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999;">地图数据加载失败，请检查 json/map.json 文件</div>';
                    });
            }
        }

        // 页面加载完成后初始化图表
        document.addEventListener('DOMContentLoaded', function () {
            initPage('exhibition_all');
            initAllCharts();
        });
    </script>
</body>

</html>